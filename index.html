<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>follow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=Noto+Sans+KR:wght@300;400&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <a href="#" class="site-title">follow</a>
  <span class="upload-hint">daily sketches</span>
</header>

<main>

  <div class="hero">
    <p class="hero-big">drawn daily,<br>followed slowly.</p>
  </div>

  <div class="upload-area">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept="image/*" multiple>
      <p>오늘의 스케치를 올려보세요</p>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <div class="gallery" id="gallery"></div>

</main>

<footer>
  <span id="count"></span>
  <span>follow</span>
</footer>

<div class="lightbox" id="lightbox">
  <span class="lightbox-close">close</span>
  <img id="lightboxImg" src="" alt="">
</div>

<script>
  // Cloudinary
  const CLOUD_NAME = 'dstwnref6';
  const UPLOAD_PRESET = 'g7fnumfe';

  // Supabase
  const SUPABASE_URL = 'https://eeivkowrojfnssuizanw.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaXZrb3dyb2pmbnNzdWl6YW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5OTMxNzksImV4cCI6MjA4NzU2OTE3OX0.NtvU4gGjLdlVasP2vXyWNYPNOS3Nrcu5YqZzQOXzV70';

  const gallery = document.getElementById('gallery');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const countEl = document.getElementById('count');
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const uploadStatus = document.getElementById('uploadStatus');

  // Supabase에서 이미지 목록 불러오기
  async function loadGallery() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/sketches?select=*&order=created_at.desc`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      const data = await res.json();

      gallery.innerHTML = '';
      data.forEach((item, i) => addToGallery(item.url, i));
      countEl.textContent = data.length > 0 ? `${data.length} sketches` : '';
    } catch (e) {
      console.error('갤러리 불러오기 실패', e);
    }
  }

  // Supabase에 URL 저장
  async function saveToSupabase(url) {
    await fetch(`${SUPABASE_URL}/rest/v1/sketches`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ url })
    });
  }

  function addToGallery(url, index = 0) {
    const item = document.createElement('div');
    item.className = 'sketch-item';
    item.style.animationDelay = `${index * 0.05}s`;
    const img = document.createElement('img');
    img.src = url;
    img.alt = '';
    img.onclick = () => {
      lightboxImg.src = url;
      lightbox.classList.add('active');
    };
    item.appendChild(img);
    gallery.insertBefore(item, gallery.firstChild);
  }

  // Cloudinary 업로드 → URL을 Supabase에 저장
  async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    uploadStatus.textContent = '올리는 중...';
    uploadStatus.className = 'upload-status uploading';

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.secure_url) {
        await saveToSupabase(data.secure_url);
        addToGallery(data.secure_url);
        const current = parseInt(countEl.textContent) || 0;
        countEl.textContent = `${current + 1} sketches`;
        uploadStatus.textContent = '업로드 완료 ✓';
        uploadStatus.className = 'upload-status done';
        setTimeout(() => { uploadStatus.textContent = ''; uploadStatus.className = 'upload-status'; }, 2000);
      }
    } catch (e) {
      uploadStatus.textContent = '업로드 실패. 다시 시도해주세요.';
      uploadStatus.className = 'upload-status error';
    }
  }

  dropZone.onclick = () => fileInput.click();
  fileInput.onchange = e => Array.from(e.target.files).forEach(uploadFile);

  dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('drag-over'); };
  dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
  dropZone.ondrop = e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    Array.from(e.dataTransfer.files).forEach(uploadFile);
  };

  lightbox.onclick = () => lightbox.classList.remove('active');

  loadGallery();
</script>

</body>

</html>
