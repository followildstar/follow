<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>follow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=Noto+Sans+KR:wght@300;400&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <a href="#" class="site-title">follow</a>
  <span class="upload-hint">daily sketches</span>
</header>

<main>

  <div class="hero">
    <p class="hero-big">drawn daily,<br>followed slowly.</p>
  </div>

  <div class="upload-area">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept="image/*" multiple>
      <p>오늘의 스케치를 올려보세요</p>
    </div>
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="upload-status" id="uploadStatus"></div>
  </div>

  <div class="gallery" id="gallery"></div>

</main>

<footer>
  <span id="count"></span>
  <span>follow</span>
</footer>

<div class="lightbox" id="lightbox">
  <span class="lightbox-close">close</span>
  <img id="lightboxImg" src="" alt="">
</div>

<script>
  const CLOUD_NAME = 'dstwnref6';
  const UPLOAD_PRESET = 'g7fnumfe';
  const SUPABASE_URL = 'https://eeivkowrojfnssuizanw.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaXZrb3dyb2pmbnNzdWl6YW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5OTMxNzksImV4cCI6MjA4NzU2OTE3OX0.NtvU4gGjLdlVasP2vXyWNYPNOS3Nrcu5YqZzQOXzV70';

  const gallery = document.getElementById('gallery');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const countEl = document.getElementById('count');
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const uploadStatus = document.getElementById('uploadStatus');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');

  const sbHeaders = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json'
  };

  // 갤러리 불러오기 — 최신순
  async function loadGallery() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/sketch?select=*&order=created_at.desc`, { headers: sbHeaders });
      const data = await res.json();
      if (!Array.isArray(data)) { console.error('Supabase 오류:', data); return; }
      gallery.innerHTML = '';
      data.forEach((item, i) => addToGallery(item.url, item.id, i, false));
      countEl.textContent = data.length > 0 ? `${data.length} sketches` : '';
    } catch (e) {
      console.error('갤러리 불러오기 실패', e);
    }
  }

  // Supabase에 저장
  async function saveToSupabase(url) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/sketch`, {
        method: 'POST',
        headers: { ...sbHeaders, 'Prefer': 'return=representation' },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) return data[0].id;
      if (data && data.id) return data.id;
      return null;
    } catch (e) {
      console.error('저장 실패', e);
      return null;
    }
  }

  // Supabase에서 삭제
  async function deleteFromSupabase(id) {
    await fetch(`${SUPABASE_URL}/rest/v1/sketch?id=eq.${id}`, {
      method: 'DELETE',
      headers: sbHeaders
    });
  }

  // 갤러리에 아이템 추가
  // prepend=true 면 맨 앞에 (새 업로드), false 면 순서대로 (불러오기)
  function addToGallery(url, id, index = 0, prepend = true) {
    const item = document.createElement('div');
    item.className = 'sketch-item';
    item.style.animationDelay = `${index * 0.05}s`;

    const img = document.createElement('img');
    img.src = url;
    img.alt = '';
    img.onclick = () => {
      lightboxImg.src = url;
      lightbox.classList.add('active');
    };

    const btn = document.createElement('button');
    btn.className = 'delete-btn';
    btn.textContent = '×';
    btn.onclick = async (e) => {
      e.stopPropagation();
      if (!confirm('삭제할까요?')) return;
      await deleteFromSupabase(id);
      item.remove();
      const current = parseInt(countEl.textContent) || 1;
      countEl.textContent = current - 1 > 0 ? `${current - 1} sketches` : '';
    };

    item.appendChild(img);
    item.appendChild(btn);

    if (prepend) {
      gallery.insertBefore(item, gallery.firstChild);
    } else {
      gallery.appendChild(item);
    }
  }

  // 업로드
  async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    uploadStatus.textContent = '올리는 중...';
    uploadStatus.className = 'upload-status uploading';
    progressWrap.classList.add('active');
    progressBar.style.width = '0%';
    setTimeout(() => { progressBar.style.width = '40%'; }, 100);
    setTimeout(() => { progressBar.style.width = '75%'; }, 900);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.secure_url) {
        progressBar.style.width = '100%';
        const id = await saveToSupabase(data.secure_url);
        addToGallery(data.secure_url, id, 0, true);
        const current = parseInt(countEl.textContent) || 0;
        countEl.textContent = `${current + 1} sketches`;
        uploadStatus.textContent = '업로드 완료 ✓';
        uploadStatus.className = 'upload-status done';
        setTimeout(() => {
          uploadStatus.textContent = '';
          uploadStatus.className = 'upload-status';
          progressWrap.classList.remove('active');
          progressBar.style.width = '0%';
        }, 2000);
      }
    } catch (e) {
      progressWrap.classList.remove('active');
      uploadStatus.textContent = '업로드 실패. 다시 시도해주세요.';
      uploadStatus.className = 'upload-status error';
    }
  }

  dropZone.onclick = () => fileInput.click();
  fileInput.onchange = e => Array.from(e.target.files).forEach(uploadFile);
  dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('drag-over'); };
  dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
  dropZone.ondrop = e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    Array.from(e.dataTransfer.files).forEach(uploadFile);
  };

  lightbox.onclick = () => lightbox.classList.remove('active');
  loadGallery();
</script>

</body>

</html>
